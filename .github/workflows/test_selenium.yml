name: 测试Selenium调试

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-selenium:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: 安装Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: 验证Chrome安装
      run: |
        google-chrome --version
        which google-chrome
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install selenium beautifulsoup4 lxml requests
        
    - name: 测试1 - Requests方法
      continue-on-error: true
      run: python test_requests_method.py
      
    - name: 测试2 - Selenium方法
      continue-on-error: true
      run: python test_selenium_debug.py
      
    - name: 上传调试文件
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-files
        path: |
          debug_*.html
          debug_*.png
        retention-days: 7
        if-no-files-found: warn
        
    - name: 显示调试信息
      if: always()
      run: |
        echo "=== 系统信息 ==="
        uname -a
        echo ""
        echo "=== Chrome版本 ==="
        google-chrome --version
        echo ""
        echo "=== Python包 ==="
        pip list | grep -i selenium
        echo ""
        echo "=== 生成的文件 ==="
        ls -lh debug_* 2>/dev/null || echo "没有debug文件"
        echo ""
        if [ -f debug_page_source.html ]; then
          echo "=== 页面源码前1000字符 ==="
          head -c 1000 debug_page_source.html
          echo ""
        fi
        if [ -f debug_requests_page.html ]; then
          echo "=== Requests页面源码前1000字符 ==="
          head -c 1000 debug_requests_page.html
          echo ""
        fi

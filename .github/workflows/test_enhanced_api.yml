name: 测试增强API

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: 创建测试脚本
      run: |
        cat > test_enhanced_api.py << 'EOF'
        import os
        import hashlib
        import hmac
        import base64
        import requests

        def generate_signsafe(params):
            """生成签名"""
            secret = "D23ABC@#56"
            sorted_keys = sorted(params.keys())
            query_string = '&'.join([f"{k}={params[k]}" for k in sorted_keys])
            sign_string = f"api-gaokao.zjzw.cn/apidata/web?{query_string}"
            
            hmac_result = hmac.new(secret.encode('utf-8'), sign_string.encode('utf-8'), hashlib.sha1).digest()
            base64_result = base64.b64encode(hmac_result).decode('utf-8')
            final_signature = hashlib.md5(base64_result.encode('utf-8')).hexdigest()
            
            return final_signature

        # 从环境变量获取Cookie
        cookie = os.getenv('GAOKAO_COOKIE', '')

        print("="*60)
        print("测试增强API")
        print("="*60)
        print(f"Cookie长度: {len(cookie)}")
        print(f"Cookie前100字符: {cookie[:100] if cookie else '(空)'}")
        print()

        # 构建参数
        params = {
            "autosign": "",
            "keyword": "",
            "local_type_id": "2073",
            "page": "1",
            "platform": "2",
            "province_id": "",
            "ranktype": "",
            "request_type": "1",
            "size": "20",
            "spe_ids": "",
            "top_school_id": "",
            "uri": "v1/school/lists"
        }

        # 生成签名
        signsafe = generate_signsafe(params)
        print(f"生成签名: {signsafe}")
        print(f"预期签名: d47a55af0610ab6193b7c4ead1eaaa56")
        print(f"签名匹配: {'✓' if signsafe == 'd47a55af0610ab6193b7c4ead1eaaa56' else '✗'}")
        print()

        # 构建URL
        sorted_keys = sorted(params.keys())
        query_parts = [f"{k}={params[k]}" for k in sorted_keys]
        query_parts.append(f"signsafe={signsafe}")
        url = f"https://api-gaokao.zjzw.cn/apidata/web?{'&'.join(query_parts)}"

        print(f"请求URL: {url[:120]}...")
        print()

        # 准备请求头
        headers = {
            "accept": "application/json, text/plain, */*",
            "accept-language": "zh-CN,zh;q=0.9",
            "content-type": "application/json",
            "origin": "https://www.gaokao.cn",
            "referer": "https://www.gaokao.cn/",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        }

        # 测试1: 不带Cookie
        print("测试1: 不带Cookie")
        print("-"*60)
        try:
            response = requests.post(url, headers=headers, timeout=15)
            print(f"状态码: {response.status_code}")
            result = response.json()
            print(f"响应code: {result.get('code')}")
            print(f"响应message: {result.get('message')}")
            if result.get('code') == 0:
                print(f"✓ 成功！获取到 {len(result.get('data', {}).get('item', []))} 条数据")
            else:
                print(f"✗ 失败")
        except Exception as e:
            print(f"错误: {e}")

        print()

        # 测试2: 带Cookie
        if cookie:
            print("测试2: 带Cookie")
            print("-"*60)
            headers_with_cookie = headers.copy()
            headers_with_cookie["cookie"] = cookie
            
            try:
                response = requests.post(url, headers=headers_with_cookie, timeout=15)
                print(f"状态码: {response.status_code}")
                result = response.json()
                print(f"响应code: {result.get('code')}")
                print(f"响应message: {result.get('message')}")
                print(f"完整响应: {result}")
                
                if result.get('code') == 0:
                    items = result.get('data', {}).get('item', [])
                    print(f"✓ 成功！获取到 {len(items)} 条数据")
                    if items:
                        print(f"第一条示例: {items[0].get('name')}")
                        print(f"label_list: {items[0].get('label_list')}")
                else:
                    print(f"✗ 失败")
            except Exception as e:
                print(f"错误: {e}")
                import traceback
                traceback.print_exc()
        else:
            print("测试2: 跳过（无Cookie）")

        print()
        print("="*60)
        EOF
    
    - name: 运行测试（带Cookie）
      env:
        GAOKAO_COOKIE: ${{ secrets.GAOKAO_COOKIE }}
      run: python test_enhanced_api.py

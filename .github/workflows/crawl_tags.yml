name: 爬取学校标签

on:
  workflow_dispatch:
    inputs:
      max_pages:
        description: '最大页数（约150页=3000所学校）'
        required: false
        default: '150'
      method:
        description: '爬取方法'
        required: true
        type: choice
        options:
          - 'requests'
          - 'selenium'
        default: 'requests'

permissions:
  contents: write

jobs:
  crawl-tags:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: 安装Chrome（如果使用Selenium）
      if: ${{ github.event.inputs.method == 'selenium' }}
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
        
    - name: 安装Python依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 创建数据目录
      run: mkdir -p data
    
    - name: 爬取标签（Requests方法）
      if: ${{ github.event.inputs.method == 'requests' }}
      run: python -m crawlers.school_tags_scraper ${{ github.event.inputs.max_pages }}
    
    - name: 爬取标签（Selenium方法）
      if: ${{ github.event.inputs.method == 'selenium' }}
      run: python -m crawlers.school_tags_selenium ${{ github.event.inputs.max_pages }}
      
    - name: 验证标签文件
      run: |
        if [ -f data/school_tags.json ]; then
          echo "✓ 标签文件生成成功"
          echo "文件大小: $(du -h data/school_tags.json)"
          echo "学校数量: $(python -c "import json; data=json.load(open('data/school_tags.json')); print(len(data))")"
        else
          echo "✗ 标签文件未生成"
          exit 1
        fi
        
    - name: 提交并推送标签数据
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 更新学校标签数据 - ${{ github.event.inputs.method }}方法
        file_pattern: 'data/school_tags*.json'
        commit_user_name: GitHub Action
        commit_user_email: action@github.com

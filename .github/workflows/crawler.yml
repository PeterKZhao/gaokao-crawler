name: 掌上高考数据爬虫

on:
  workflow_dispatch:
    inputs:
      crawl_schools:
        description: '爬取学校数据'
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'
      max_school_pages:
        description: '学校最大页数'
        required: false
        default: '10'
      fetch_school_detail:
        description: '获取学校详细信息'
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'
      fetch_enhanced:
        description: '获取增强数据（需要Cookie）'
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'
      crawl_majors:
        description: '爬取专业数据'
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'
      crawl_scores:
        description: '爬取分数线数据'
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'
      sample_schools:
        description: '爬取分数线的学校数量'
        required: false
        default: '10'

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 创建数据目录
      run: mkdir -p data
    
    # 添加调试步骤
    - name: 检查Cookie Secret
      if: ${{ github.event.inputs.crawl_schools == 'true' && github.event.inputs.fetch_enhanced == 'true' }}
      run: |
        if [ -z "${{ secrets.GAOKAO_COOKIE }}" ]; then
          echo "⚠️  GAOKAO_COOKIE Secret未设置或为空"
          echo "请在 Settings -> Secrets and variables -> Actions 中添加 GAOKAO_COOKIE"
        else
          echo "✓ GAOKAO_COOKIE Secret已设置（长度: ${#GAOKAO_COOKIE}）"
        fi
      env:
        GAOKAO_COOKIE: ${{ secrets.GAOKAO_COOKIE }}
    
    - name: 爬取学校数据
      if: ${{ github.event.inputs.crawl_schools == 'true' }}
      env:
        MAX_PAGES: ${{ github.event.inputs.max_school_pages }}
        FETCH_DETAIL: ${{ github.event.inputs.fetch_school_detail }}
        FETCH_ENHANCED: ${{ github.event.inputs.fetch_enhanced }}
        GAOKAO_COOKIE: ${{ secrets.GAOKAO_COOKIE }}
      run: python -m crawlers.schools
    
    - name: 爬取专业数据
      if: ${{ github.event.inputs.crawl_majors == 'true' }}
      run: python -m crawlers.majors
    
    - name: 爬取分数线数据
      if: ${{ github.event.inputs.crawl_scores == 'true' }}
      env:
        SAMPLE_SCHOOLS: ${{ github.event.inputs.sample_schools }}
      run: python -m crawlers.scores
      
    - name: 提交并推送更改
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 更新数据 ${{ github.run_number }}
        file_pattern: 'data/*.json'
        commit_user_name: GitHub Action
        commit_user_email: action@github.com
